on:
 push:
jobs:
  linux-x86_64:
    runs-on: ubuntu-18.04
    steps:
      - uses: actions/checkout@v2
      - name: Run tests on linux-x86_64
        shell: bash
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          echo "/opt/protobuf/bin" >> $GITHUB_PATH
           curl -fsSL https://github.com/google/protobuf/releases/download/v3.5.1/protobuf-cpp-3.5.1.tar.gz \
                         | tar xz && \
                         cd protobuf-3.5.1 && \
                         ./configure --prefix=/opt/protobuf && \
                         make -j2 && \
                         make install && \
                         cd .. && \
                         rm -rf protobuf-3.5.1

          echo "Verifying programs on path. Path is $PATH"
          export PATH="/opt/cmake/bin:/opt/maven/bin:/opt/protobuf/bin:$PATH"
          echo "Path post update is $PATH. Maven is at `which mvn` cmake is at `which cmake` protoc is at `which protoc`"
          mvn --version
          cmake --version
          protoc --version
          mvn  -Dlibnd4j.chip=cpu clean install -DskipTests

  linux-x86_64-cuda_11-0:
    runs-on: ubuntu-18.04
    steps:
      - uses: actions/checkout@v2
      - uses: konduitai/cuda-install@master/.github/actions/install-cuda-ubuntu
        env:
          cuda: 11.0.167
      - name: Build cuda
        shell: bash
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
                curl -fsSL https://github.com/google/protobuf/releases/download/v3.5.1/protobuf-cpp-3.5.1.tar.gz \
                               | tar xz && \
                               cd protobuf-3.5.1 && \
                               ./configure --prefix=/opt/protobuf && \
                               make -j2 && \
                               make install && \
                               cd .. && \
                               rm -rf protobuf-3.5.1
                mvn -Dlibnd4j.chip=cuda clean install -DskipTests

  linux-x86_64-cuda-11-2:
    runs-on: ubuntu-18.04
    steps:
      - uses: actions/checkout@v2
      - uses: konduitai/cuda-install@master/.github/actions/install-cuda-ubuntu
          env:
            cuda: 11.2.1_461
      - name: Run tests on linux-x86_64
        shell: bash
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
               curl -fsSL https://github.com/google/protobuf/releases/download/v3.5.1/protobuf-cpp-3.5.1.tar.gz \
                             | tar xz && \
                             cd protobuf-3.5.1 && \
                             ./configure --prefix=/opt/protobuf && \
                             make -j2 && \
                             make install && \
                             cd .. && \
                             rm -rf protobuf-3.5.1


              nvcc --version
              mvn --version
              cmake --version
              protoc --version
              mvn  -Dlibnd4j.chip=cuda clean install -DskipTests

  android-x86_64:
      runs-on: ubuntu-18.04
      steps:
        - uses: actions/checkout@v2
        - name: Build on linux-x86_64
          run: |
             curl -fsSL https://github.com/google/protobuf/releases/download/v3.5.1/protobuf-cpp-3.5.1.tar.gz \
                           | tar xz && \
                           cd protobuf-3.5.1 && \
                           ./configure --prefix=/opt/protobuf && \
                           make -j2 && \
                           make install && \
                           cd .. && \
                           rm -rf protobuf-3.5.1

            curl -s http://dl.google.com/android/repository/android-ndk-r18b-linux-x86_64.zip -o android-ndk-r18b-linux-x86_64.zip && \
            unzip -q android-ndk-r18b-linux-x86_64.zip -d /opt && \
            rm -f android-ndk-r18b-linux-x86_64.zip
            echo "Verifying programs on path. Path is $PATH"
            export PATH="/opt/cmake/bin:/opt/maven/bin:/opt/protobuf/bin:$PATH"
            echo "Path post update is $PATH. Maven is at `which mvn` cmake is at `which cmake` protoc is at `which protoc`"
            mvn --version
            cmake --version
            protoc --version
            mvn -Djavacpp.platform=android-x86_64 -libnd4j.platform=android-x86_64 -Ptest-nd4j-native -Dlibnd4j.chip=cpu clean install -DskipTests

  windows-x86_64:
      runs-on: windows-2019
      steps:
        - name: Use existing msys2 to setup environment
          uses: eclipse/deeplearning4j/.github/actions/msys2-base-setup@actions
        - uses: actions/checkout@v2
        - name: Run tests
          shell: cmd
          run: |
            set MSYSTEM=MINGW64
            mvn -Djavacpp.platform=windows-x86_64 -libnd4j.platform=windows-x86_64  -Dlibnd4j.chip=cpu clean install -DskipTests

  windows-x86_64-cuda-11-2:
    runs-on: windows-2019
    steps:
      - name: Use existing msys2 to setup environment
        uses: eclipse/deeplearning4j/.github/actions/msys2-base-setup@actions
      - name: Install cuda on windows
        uses: eclipse/deeplearning4j/.github/actions/install-cuda-windows@actions
      - uses: actions/checkout@v2
      - name: Run tests
        shell: cmd
        run: |
          set MSYSTEM=MINGW64
          call "C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
          mvn -Djavacpp.platform=windows-x86_64 -libnd4j.platform=windows-x86_64 -Pcuda -Dlibnd4j.chip=cuda -Pcuda clean install -DskipTests



  mac-x86_64:
      runs-on: macos-10.15
      steps:
        - uses: actions/checkout@v2
        - name: Install and run tests
          shell: bash
          run: |
            brew install unzip  ccache gcc swig autoconf-archive automake cmake libomp libtool libusb ant maven nasm xz pkg-config sdl gpg1 bison flex perl ragel binutils gradle gmp isl libmpc mpfr wget
            mvn -Djavacpp.platform=macosx-x86_64 -libnd4j.platform=macosx-x86_64 -Ptest-nd4j-native -Dlibnd4j.chip=cpu clean install -DskipTests

